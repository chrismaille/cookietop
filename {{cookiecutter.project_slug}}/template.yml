AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: {{ cookiecutter.project_description }}

Globals:
  Function:
    Runtime: python{{ cookiecutter.python_version }}
    Layers:
      - Ref: {{cookiecutter.project_name_camel}}DepLayer
      - arn:aws:lambda:us-east-1:898466741470:layer:psycopg2-py37:3
    Environment:
      Variables:
        # Use file local.json to override these values in sam local start-api
        {% raw %}
        ENVIRONMENT: '{{resolve:ssm:NoverdeEnvironment:1}}'
        LOGGER_LEVEL: '{{resolve:ssm:/{% endraw %}{{cookiecutter.project_name_camel}}{% raw %}/settings/logLevel:1}}'
        SENTRY_ENDPOINT: '{{resolve:ssm:/{% endraw %}{{cookiecutter.project_name_camel}}{% raw %}/endpoints/sentry:1}}'
        DATABASE_SQL_URL: '{{resolve:ssm:/{% endraw %}{{cookiecutter.project_name_camel}}{% raw %}/endpoints/rds:1}}'
        {% endraw %}
  Api:
    Cors:
      AllowOrigin: "'*'"
      AllowHeaders: "'Content-Type,Authorization'"

Resources:
  #  Handlers Configuration
  HealthCheck:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: {{cookiecutter.project_slug}}-health-check
      CodeUri: {{cookiecutter.project_slug}}
      Handler: interface.handlers.health.health_check
      Policies:
        - AWSLambdaFullAccess
      Tags:
        noverde:
          service:{{ cookiecutter.project_name_camel }}
      Events:
        GetHealth:
          Type: Api
          Properties:
            Path: /health
            Method: get
            RestApiId:
              Ref: {{cookiecutter.project_name_camel}}Api

  # Lambda Layer Configuration
  {{cookiecutter.project_name_camel}}DepLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: sam-{{cookiecutter.project_slug}}-dependencies
      Description: Dependencies for sam app [{{cookiecutter.project_slug}}]
      ContentUri: dependencies
      CompatibleRuntimes:
        - python3.7
      LicenseInfo: 'MIT'

  # Api Gateway Configuration
  {{cookiecutter.project_name_camel}}Api:
    Type: AWS::Serverless::Api
    Properties:
      Name: {{cookiecutter.project_name_camel}}Api
      OpenApiVersion: "3.0.3"
      TracingEnabled: true
      StageName: v1